import pandas as pd
import joblib
import os

def load_exploit_data():
    path = os.path.join(os.path.dirname(__file__), '..', 'data', 'exploits', 'exploitdb', 'files_exploits.csv')
    data = pd.read_csv(path)
    #print(data.columns)  
    return data

def load_model():
    model_path = os.path.join(os.path.dirname(__file__), '..', 'models', 'exploit_model.pkl')
    return joblib.load(model_path)

def generate_exploit(exploit_name, ip):
    data = load_exploit_data()
    #print("load exploit")
    model = load_model()
    #print("load model")
    
    predicted_id = model.predict([exploit_name])[0]
    
    
    selected_exploit = data[data['id'] == predicted_id]
    
    if not selected_exploit.empty:
        description = selected_exploit['description'].iloc[0]
        exploit_file = selected_exploit['file'].iloc[0]  
        
        
        exploit_file_path = os.path.join(
            os.path.dirname(__file__), 
            '..', 
            'data', 
            'exploits', 
            'exploitdb', 
            exploit_file
        )
        
        
        try:
            with open(exploit_file_path, 'r') as file:
                file_content = file.read()
        except FileNotFoundError:
            file_content = "Exploit file not found."
        
        
        output = f"Exploit for: {exploit_name}\n" \
                 f"Target IP: {ip}\n" \
                 f"Description: {description}\n\n" \
                 f"Exploit Code:\n{file_content}"
        
        return output
    else:
        return "Exploit not found."


